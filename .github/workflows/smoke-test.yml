name: Smoke Tests

# Controls when the workflow will run
on: [push, pull_request, workflow_dispatch]

env:
  MAX_ATTEMPTS: 3
  TIMEOUT: 10

jobs:
  pro:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        cluster: [v1.20.2, v1.19.7, v1.18.15, v1.17.17, v1.16.15]
        mode: [tyk-pro,tyk-cp]
    steps:
      - uses: actions/checkout@v2

      - name: Create Kind Cluster
        uses: engineerd/setup-kind@v0.5.0
        with:
          version: "v0.11.1"
          config: .github/kind-cluster-${{ matrix.cluster }}.yml

      - name: Install helm
        uses: Azure/setup-helm@v1.1
        with:
          version: v3.5.3

      - name: Copy .env file
        run: cp .env.example .env

      - name: Deploy basic ${{ matrix.mode }}
        uses: nick-invision/retry@v2
        with:
          max_attempts: ${{ env.MAX_ATTEMPTS }}
          timeout_minutes: ${{ env.TIMEOUT }}
          on_retry_command: kubectl delete ns ${{ matrix.mode }}
          command: |
            LICENSE="${{ secrets.DASH_LICENSE }}" \
            MDCB_LICENSE="${{ secrets.MDCB_LICENSE }}" \
            ./up.sh \
              --namespace ${{ matrix.mode }} \
              ${{ matrix.mode }}

      - name: Deploy ${{ matrix.mode }} with a redis cluster
        uses: nick-invision/retry@v2
        with:
          max_attempts: ${{ env.MAX_ATTEMPTS }}
          timeout_minutes: ${{ env.TIMEOUT }}
          on_retry_command: kubectl delete ns ${{ matrix.mode }}-redis-cluster
          command: |
            LICENSE="${{ secrets.DASH_LICENSE }}" \
            MDCB_LICENSE="${{ secrets.MDCB_LICENSE }}" \
            ./up.sh \
              --namespace ${{ matrix.mode }}-redis-cluster \
              --redis redis-cluster \
              ${{ matrix.mode }}

      # - name: Deploy ${{ matrix.mode }} with postgres
      #   uses: nick-invision/retry@v2
      #   with:
      #     max_attempts: ${{ env.MAX_ATTEMPTS }}
      #     timeout_minutes: ${{ env.TIMEOUT }}
      #     command: |
      #       LICENSE="${{ secrets.DASH_LICENSE }}" \
      #       MDCB_LICENSE="${{ secrets.MDCB_LICENSE }}" \
      #       ./up.sh \
      #         --namespace ${{ matrix.mode }}-postgres \
      #         --storage postgres \
      #         ${{ matrix.mode }}

  worker:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        cluster: [v1.20.2, v1.19.7, v1.18.15, v1.17.17, v1.16.15]
        mode: [tyk-worker]
    steps:
      - uses: actions/checkout@v2

      - name: Create Kind Cluster
        uses: engineerd/setup-kind@v0.5.0
        with:
          version: "v0.11.1"
          config: .github/kind-cluster-${{ matrix.cluster }}.yml

      - name: Install helm
        uses: Azure/setup-helm@v1.1
        with:
          version: v3.5.3

      - name: Copy .env file
        run: cp .env.example .env

      - name: Deploy basic ${{ matrix.mode }}
        uses: nick-invision/retry@v2
        with:
          max_attempts: ${{ env.MAX_ATTEMPTS }}
          timeout_minutes: ${{ env.TIMEOUT }}
          on_retry_command: kubectl delete ns ${{ matrix.mode }}
          command: |
            echo "WORKER_MDCB_HOST: ${{ secrets.WORKER_MDCB_HOST }}" && \
            echo "WORKER_RPC_KEY: ${{ secrets.WORKER_RPC_KEY }}" && \
            echo "WORKER_API_KEY: ${{ secrets.WORKER_API_KEY }}" && \
            TYK_WORKER_CONNECTIONSTRING="${{ secrets.WORKER_MDCB_HOST }}" \
            TYK_WORKER_ORGID="${{ secrets.WORKER_RPC_KEY }}" \
            TYK_WORKER_AUTHTOKEN="${{ secrets.WORKER_API_KEY }}" \
            ./up.sh \
              --namespace ${{ matrix.mode }} \
              ${{ matrix.mode }}

      - name: Deploy ${{ matrix.mode }} with a redis cluster
        uses: nick-invision/retry@v2
        with:
          max_attempts: ${{ env.MAX_ATTEMPTS }}
          timeout_minutes: ${{ env.TIMEOUT }}
          on_retry_command: kubectl delete ns ${{ matrix.mode }}-redis-cluster
          command: |
            TYK_WORKER_CONNECTIONSTRING="${{ secrets.WORKER_MDCB_HOST }}" \
            TYK_WORKER_ORGID="${{ secrets.WORKER_RPC_KEY }}" \
            TYK_WORKER_AUTHTOKEN="${{ secrets.WORKER_API_KEY }}" \
            ./up.sh \
              --namespace ${{ matrix.mode }}-redis-cluster \
              --redis redis-cluster \
              ${{ matrix.mode }}

  oss:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        cluster: [v1.20.2, v1.19.7, v1.18.15, v1.17.17, v1.16.15]
        mode: [tyk-gateway]
    steps:
      - uses: actions/checkout@v2

      - name: Create Kind Cluster
        uses: engineerd/setup-kind@v0.5.0
        with:
          version: "v0.11.1"
          config: .github/kind-cluster-${{ matrix.cluster }}.yml

      - name: Install helm
        uses: Azure/setup-helm@v1.1
        with:
          version: v3.5.3

      - name: Copy .env file
        run: cp .env.example .env

      - name: Deploy basic ${{ matrix.mode }}
        uses: nick-invision/retry@v2
        with:
          max_attempts: ${{ env.MAX_ATTEMPTS }}
          timeout_minutes: ${{ env.TIMEOUT }}
          on_retry_command: kubectl delete ns ${{ matrix.mode }}
          command: |
            ./up.sh \
              --namespace ${{ matrix.mode }} \
              ${{ matrix.mode }}

      - name: Deploy ${{ matrix.mode }} with a redis cluster
        uses: nick-invision/retry@v2
        with:
          max_attempts: ${{ env.MAX_ATTEMPTS }}
          timeout_minutes: ${{ env.TIMEOUT }}
          on_retry_command: kubectl delete ns ${{ matrix.mode }}
          command: |
            ./up.sh \
              --namespace ${{ matrix.mode }}-redis-cluster \
              --redis redis-cluster \
              ${{ matrix.mode }}
